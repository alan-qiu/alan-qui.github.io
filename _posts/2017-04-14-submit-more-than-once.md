---
layout: post
data: 2017-04-14 10:45:00
modified: 2017-04-14 10:45:00
title: 重复提交
---

之前在项目中也遇到过表单重复提交的问题，当时的做法是使用 JavaScript 在提交表单后禁止提交按钮。最近在尝试使用 Laravel 写 API，又考虑到了这个问题。做了些 Google，把几种思路写下来，供以后参考。

## 使用数据库约束

对关键字段做唯一性约束，在 model 里编写 validation。好处是可以防止多次创建记录，坏处是要处理重复的请求，也要编写客户端的错误处理。

做了唯一性要求的表，最好也做 index，应该会改善性能（响应）。

## 禁止提交按钮

主要想法就是把 submit 的按钮在提交后改为 disabled。这个做法简单，好用。可以应对常见的场景，不能应对恶意（bug）的重复提交。

## 使用 token

在服务端和客户端使用 token 确认提交是重复。

比如在 new 或 edit 的动作时生成 token 存储在 redis 中，同时发送给客户端，客户端提交表单是携带这个 token。如果是第一次提交，在 redis 中可以查询到该 token，处理请求，然后删除 token。如果是重复提交，在 redis 中查询不到对应的 token，忽略这次表单提交。

## 使用 etag

使用 etag 判断 post 提交的对象是否已经改变。思路和 token 类似，使用的具体手段不同。
